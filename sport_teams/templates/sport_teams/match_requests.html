{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Match Requests</h2>
    
    <!-- Received Requests -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Received Requests</h3>
        </div>
        <div class="card-body">
            {% if received_requests %}
                {% for request in received_requests %}
                    <div class="match-request-item mb-3 p-3 border rounded">
                        <h4>From: {{ request.challenger.name }}</h4>
                        <p>Date: {{ request.preferred_date }}</p>
                        <p>Time: {{ request.preferred_time.get_slot_time_display }}</p>
                        {% if request.preferred_facility %}
                            <p>Facility: {{ request.preferred_facility.name }}</p>
                        {% endif %}
                        {% if request.message %}
                            <p>Message: {{ request.message }}</p>
                        {% endif %}
                        <div class="actions mt-2">
                            {% if request.status == 'pending' %}
                                <button class="btn btn-success accept-btn" data-request-id="{{ request.id }}">
                                    <i class="fas fa-check me-1"></i>Accept
                                </button>
                                <button class="btn btn-danger reject-btn" data-request-id="{{ request.id }}" data-bs-toggle="modal" data-bs-target="#rejectModal{{ request.id }}">
                                    <i class="fas fa-times me-1"></i>Reject
                                </button>
                                <a href="{% url 'sport_teams:reschedule_match' request_id=request.id %}" class="btn btn-warning">
                                    <i class="fas fa-calendar-alt me-1"></i>Reschedule
                                </a>
                            {% else %}
                                <span class="badge bg-{{ request.status|lower }}-subtle text-{{ request.status|lower }}">
                                    {{ request.status|title }}
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Reject Modal -->
                    <div class="modal fade" id="rejectModal{{ request.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Reject Match Request</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="rejectForm{{ request.id }}">
                                        <div class="mb-3">
                                            <label for="rejectMessage{{ request.id }}" class="form-label">Reason for rejection (optional):</label>
                                            <textarea class="form-control" id="rejectMessage{{ request.id }}" rows="3"></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger reject-confirm" data-request-id="{{ request.id }}">
                                        <i class="fas fa-times me-1"></i>Reject Request
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No received requests.</p>
            {% endif %}
        </div>
    </div>

<!-- JavaScript for handling actions -->
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle Accept button clicks
    document.querySelectorAll('.accept-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!confirm('Are you sure you want to accept this match request?')) {
                return;
            }

            const requestId = this.dataset.requestId;
            const button = this;
            button.disabled = true;
            
            fetch(`/sport_teams/match/accept/${requestId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert('danger', data.message);
                    button.disabled = false;
                }
            })
            .catch(error => {
                showAlert('danger', 'An error occurred while processing your request.');
                console.error('Error:', error);
                button.disabled = false;
            });
        });
    });

    // Handle Reject button clicks
    document.querySelectorAll('.reject-confirm').forEach(btn => {
        btn.addEventListener('click', function() {
            const requestId = this.dataset.requestId;
            const message = document.querySelector(`#rejectMessage${requestId}`).value;
            const button = this;
            
            if (!confirm('Are you sure you want to reject this match request?')) {
                return;
            }
            
            button.disabled = true;
            
            fetch(`/sport_teams/match/reject/${requestId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert('danger', data.message);
                    button.disabled = false;
                }
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.querySelector(`#rejectModal${requestId}`));
                modal.hide();
            })
            .catch(error => {
                showAlert('danger', 'An error occurred while processing your request.');
                console.error('Error:', error);
                button.disabled = false;
            });
        });
    });

    // Utility function to show alerts
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '1050';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

    <!-- Sent Requests -->
    <div class="card">
        <div class="card-header">
            <h3>Sent Requests</h3>
        </div>
        <div class="card-body">
            {% if sent_requests %}
                {% for request in sent_requests %}
                    <div class="match-request-item mb-3 p-3 border rounded">
                        <h4>To: {{ request.opponent.name }}</h4>
                        <p>Date: {{ request.preferred_date }}</p>
                        <p>Time: {{ request.preferred_time }}</p>
                        {% if request.preferred_facility %}
                            <p>Facility: {{ request.preferred_facility.name }}</p>
                        {% endif %}
                        <p>Status: {{ request.status|title }}</p>
                        {% if request.status == 'pending' %}
                            <a href="{% url 'sport_teams:reschedule_match' request_id=request.id %}" class="btn btn-warning">Reschedule</a>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>No sent requests.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle accept button clicks
        document.querySelectorAll('.accept-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const requestId = this.dataset.requestId;
                fetch(`/teams/match/accept/${requestId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            });
        });

        // Handle reject button clicks
        document.querySelectorAll('.reject-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const requestId = this.dataset.requestId;
                fetch(`/teams/match/reject/${requestId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            });
        });

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}