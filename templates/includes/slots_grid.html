{% load static %}

<style>
.time-slots {
    padding: 2rem 0;
}
.slot-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}
.slot-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
    transition: all 0.3s ease;
}
.slot-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}
.slot-time {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}
.slot-time i {
    color: #6c757d;
}
.slot-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}
.status-available {
    background-color: #e8f5e9;
    color: #2e7d32;
}
.status-lunch {
    background-color: #fff3e0;
    color: #f57c00;
}
.status-booked {
    background-color: #ffebee;
    color: #c62828;
}
.status-past {
    background-color: #f5f5f5;
    color: #9e9e9e;
}
.book-now-btn {
    background-color: #4caf50;
    color: white !important;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 25px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    cursor: pointer;
    width: 100%;
    text-decoration: none;
    display: inline-block;
}
.book-now-btn:hover {
    background-color: #43a047;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
}
.book-now-btn i {
    margin-right: 0.5rem;
}
</style>

<div class="slot-grid">
    {% for slot in available_slots %}
    <div class="slot-card {% if slot.is_past %}past{% endif %}">
        <div class="slot-time">
            <i class="far fa-clock"></i>
            {{ slot.display_time }}
        </div>
        
        {% if slot.is_past %}
            <div class="slot-status status-past">
                <i class="fas fa-clock"></i>
                Past
            </div>
        {% elif slot.slot_time == "12:00-13:00" %}
            <div class="slot-status status-lunch">
                <i class="fas fa-utensils"></i>
                Lunch Break
            </div>
        {% else %}
            {% if slot.is_available %}
                <div class="slot-status status-available">
                    <i class="fas fa-check-circle"></i>
                    Available
                </div>
                {% if user.is_authenticated %}
                    <button class="book-now-btn" 
                            data-slot-id="{{ slot.id }}"
                            data-slot-time="{{ slot.display_time }}"
                            data-slot-start="{{ slot.start_time }}"
                            data-slot-end="{{ slot.end_time }}"
                            data-bs-toggle="modal"
                            data-bs-target="#bookingModal"
                            onclick="openBookingModal(this)">
                        <i class="fas fa-calendar-check"></i>
                        Book Now
                    </button>
                {% else %}
                    <a href="{% url 'login' %}?next={% url 'booking-create' %}" 
                       class="book-now-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        Login to Book
                    </a>
                {% endif %}
            {% else %}
                <div class="slot-status status-booked">
                    <i class="fas fa-lock"></i>
                    Booked
                </div>
            {% endif %}
        {% endif %}
    </div>
    {% empty %}
    <div class="col-12 text-center py-5">
        <h4>No slots available for this date</h4>
        <p>Please try selecting a different date.</p>
    </div>
    {% endfor %}
</div>

{% if user.is_authenticated %}
<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" method="post" action="{% url 'booking-create' %}">
                    {% csrf_token %}
                    <input type="hidden" name="slot_id" id="slotIdInput">
                    <div class="mb-3">
                        <label class="form-label">Sport Type</label>
                        <select name="sport_id" class="form-select" required>
                            {% for sport in turf_sports %}
                            <option value="{{ sport.id }}">{{ sport.sport.name }} - ₹{{ sport.price_per_slot }}/slot</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="booking-summary">
                        <h6>Booking Details</h6>
                        <p>Date: <span id="bookingDate"></span></p>
                        <p>Time: <span id="bookingTime"></span></p>
                        <p>Price: ₹<span id="bookingPrice"></span></p>
                        {% if offers %}
                        <div class="mb-3">
                            <label class="form-label">Available Offers</label>
                            <select name="offer_id" class="form-select">
                                <option value="">No offer</option>
                                {% for offer in offers %}
                                <option value="{{ offer.id }}">{{ offer.title }} - {{ offer.discount_percentage }}% off</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="bookingForm" class="btn btn-primary">Confirm Booking</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// This function is called when a booking button is clicked
function openBookingModal(btn) {
    const slotId = btn.dataset.slotId;
    const slotTime = btn.dataset.slotTime;
    const bookingDate = document.querySelector('#selected_date')?.value || new Date().toISOString().split('T')[0];
    
    // Set form values
    document.querySelector('#slotIdInput').value = slotId;
    document.querySelector('#bookingTime').textContent = slotTime;
    document.querySelector('#bookingDate').textContent = bookingDate;
    
    // Get initial price from first sport option
    const sportSelect = document.querySelector('select[name="sport_id"]');
    if (sportSelect) {
        const firstOption = sportSelect.options[0];
        if (firstOption) {
            const priceMatch = firstOption.text.match(/₹(\d+)/);
            if (priceMatch) {
                document.querySelector('#bookingPrice').textContent = priceMatch[1];
            }
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Update price when sport changes
    document.querySelector('select[name="sport_id"]')?.addEventListener('change', function() {
        const priceMatch = this.options[this.selectedIndex].text.match(/₹(\d+)/);
        if (priceMatch) {
            document.querySelector('#bookingPrice').textContent = priceMatch[1];
        }
    });

    // Update price when offer changes
    document.querySelector('select[name="offer_id"]')?.addEventListener('change', function() {
        const sportSelect = document.querySelector('select[name="sport_id"]');
        const priceMatch = sportSelect.options[sportSelect.selectedIndex].text.match(/₹(\d+)/);
        if (priceMatch) {
            let price = parseInt(priceMatch[1]);
            const discountMatch = this.options[this.selectedIndex].text.match(/(\d+)%/);
            if (discountMatch && this.value) {
                const discount = parseInt(discountMatch[1]);
                price = price * (100 - discount) / 100;
            }
            document.querySelector('#bookingPrice').textContent = price.toFixed(0);
        }
    });
});
</script>