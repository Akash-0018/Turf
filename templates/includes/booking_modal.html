{% if user.is_authenticated %}
<!-- Book a Slot Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-wrapper">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-plus gradient-icon me-2"></i>Book Your Perfect Slot
                    </h5>
                    <p class="modal-subtitle mb-0">Ready for some action? Let's secure your spot! ðŸŽ¯</p>
                </div>
                <button type="button" class="btn-close custom-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" action="{% url 'booking-create' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="time_slot" id="slotIdInput">
                    <input type="hidden" name="facility_sport" id="facilitySportInput">
                    <input type="hidden" name="date" id="bookingDate">
                    
                    <div class="booking-grid">
                        <!-- Left Column -->
                        <div class="booking-info-column">
                            <!-- Selected Time Display -->
                            <div class="time-selector-card">
                                <div class="card-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="time-details">
                                    <label class="form-label">Your Selected Time</label>
                                    <h3 class="selected-time" id="selectedTime"></h3>
                                </div>
                            </div>

                            <!-- Facility & Sport Selection -->
                            <!-- Removed facility selector dropdown to use hidden input -->

                        </div>

                        <!-- Right Column -->
                        <div class="booking-summary-column">
                            <!-- Booking Summary -->
                            <div class="booking-summary mt-4 d-none">
                                <div class="summary-header">
                                    <i class="fas fa-receipt gradient-icon me-2"></i>
                                    <h6 class="summary-title mb-0">Booking Summary</h6>
                                </div>
                                
                                <div class="summary-content">
                                    <div class="summary-item">
                                        <div class="item-icon">
                                            <i class="fas fa-calendar-day"></i>
                                        </div>
                                        <div class="item-details">
                                            <span class="label">Date</span>
                                            <span class="value" id="summaryDate"></span>
                                        </div>
                                    </div>

                                    <div class="summary-item">
                                        <div class="item-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="item-details">
                                            <span class="label">Time</span>
                                            <span class="value" id="summaryTime"></span>
                                        </div>
                                    </div>

                                    <div class="summary-item">
                                        <div class="item-icon">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </div>
                                        <div class="item-details">
                                            <span class="label">Facility & Sport</span>
                                            <span class="value" id="summaryFacility"></span>
                                        </div>
                                    </div>

                                    <div class="price-summary">
                                        <div class="price-row">
                                            <span>Base Price</span>
                                            <span class="amount">â‚¹<span id="summaryPrice"></span></span>
                                        </div>
                                        <div class="price-row total">
                                            <span>Final Price</span>
                                            <span class="amount">â‚¹<span id="summaryFinalPrice"></span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="submit" form="bookingForm" class="btn btn-primary">
                    <i class="fas fa-check me-2"></i>Confirm Booking
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookingModal = document.getElementById('bookingModal');
    const facilitySportInput = document.getElementById('facilitySportInput');
    const summaryFacility = document.getElementById('summaryFacility');
    const summaryPrice = document.getElementById('summaryPrice');
    const summaryFinalPrice = document.getElementById('summaryFinalPrice');
    const bookingSummary = document.querySelector('.booking-summary');

    // Function to open modal with booking data
    window.openBookingModal = function(button) {
        const bookingData = JSON.parse(button.dataset.booking);
        document.getElementById('slotIdInput').value = bookingData.id;
        document.getElementById('selectedTime').textContent = bookingData.display_time;
        document.getElementById('bookingDate').value = bookingData.date || '';
        facilitySportInput.value = bookingData.facility_sport_id || '';

        summaryFacility.textContent = bookingData.sport_name || '';
        summaryPrice.textContent = bookingData.base_price.toFixed(2);
        summaryFinalPrice.textContent = bookingData.final_price.toFixed(2);
        document.getElementById('summaryDate').textContent = bookingData.date;
        document.getElementById('summaryTime').textContent = bookingData.display_time;

        bookingSummary.classList.remove('d-none');
    };

    // Handle form submission
    const bookingForm = document.getElementById('bookingForm');
    bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Booking failed');
            return response.json();
        })
        .then(data => {
            if (data.status === 'error') {
                alert('Error creating booking: ' + data.message);
                return;
            }
            const modalInstance = bootstrap.Modal.getInstance(bookingModal);
            modalInstance.hide();
            alert('Booking created successfully!');
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating booking. Please try again.');
        });
    });
});
</script>
{% endif %}
